<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>لوحة التحكم (سري)</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <nav aria-label="الرئيسي">
            <a class="nav-link" href="../index.html">الرئيسيّة</a>

    <a class="nav-link" href="pages/category.html?category=highlights">الأخبار الهامة</a>
    <a class="nav-link" href="pages/category.html?category=local">محليات</a>
    <a class="nav-link" href="pages/category.html?category=international">إقليمي ودولي</a>
    <a class="nav-link" href="pages/category.html?category=economy">اقتصاد</a>
    <!-- admin link intentionally NOT shown -->
    <a class="brand" href="index.html"><span class="brand-text">RAMYAH NEWS</span></a>
  </nav>
</header>

<main style="max-width:900px;margin:18px auto;padding:18px">
  <div id="loginBox">
    <h2>تسجيل الدخول</h2>
    <form id="loginForm">
      <div class="form-row"><label>اسم المستخدم</label><input name="username" required></div>
      <div class="form-row"><label>كلمة المرور</label><input name="password" type="password" required></div>
      <div class="form-row"><button class="btn" type="submit">دخول</button></div>
      <small id="loginMsg"></small>
    </form>
  </div>

  <div id="adminUI" style="display:none">
    <h2>إنشاء خبر جديد</h2>
    <form id="articleForm">
      <div class="form-row"><label>العنوان</label><input name="title" required></div>
      <div class="form-row"><label>القسم</label>
        <select name="category">
          <option value="highlights">الأخبار الهامة</option>
          <option value="urgent">العواجل</option>
          <option value="local">محليات</option>
          <option value="international">إقليمي ودولي</option>
          <option value="economy" selected>اقتصاد</option>
        </select>
      </div>
      <div class="form-row" id="imageRow"><label>رابط الصورة (URL)</label><input name="image"></div>
      <div class="form-row" id="summaryRow"><label>ملخص</label><textarea name="summary" rows="3"></textarea></div>
      <div class="form-row"><label>المحتوى</label><textarea name="content" rows="6" required></textarea></div>
      <div class="form-row"><label><input type="checkbox" name="breaking"> خبر عاجل</label></div>
      <div class="form-row">
        <button class="btn" type="submit">نشر إلى السيرفر</button>
        <button class="btn" type="button" id="logoutBtn" style="background:#777;margin-right:8px">خروج</button>
      </div>
      <small id="msg"></small>
    </form>
  </div>
</main>

<!-- Load JavaScript modules -->
<script src="js/api.js"></script>
<script>
const loginForm = document.getElementById('loginForm');
const loginMsg = document.getElementById('loginMsg');
const loginBox = document.getElementById('loginBox');
const adminUI = document.getElementById('adminUI');
const articleForm = document.getElementById('articleForm');
const msg = document.getElementById('msg');
const logoutBtn = document.getElementById('logoutBtn');

// Token management
function setToken(t){ sessionStorage.setItem('ramya_token', t); }
function getToken(){ return sessionStorage.getItem('ramya_token'); }
function showLoggedIn(){ loginBox.style.display='none'; adminUI.style.display='block'; }
function showLoggedOut(){ loginBox.style.display='block'; adminUI.style.display='none'; sessionStorage.removeItem('ramya_token'); }

// Login form handler
loginForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(loginForm);
  loginMsg.textContent = 'جاري تسجيل الدخول...';
  try{
    const result = await api.login(fd.get('username'), fd.get('password'));
    setToken(result.access_token);
    loginMsg.textContent = 'تم الدخول بنجاح';
    showLoggedIn();
  }catch(err){
    loginMsg.textContent = 'خطأ في بيانات الدخول';
  }
});

// Logout handler
logoutBtn.addEventListener('click', ()=>{
  showLoggedOut();
  loginMsg.textContent = 'تم تسجيل الخروج';
});

// Article creation form handler
articleForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const token = getToken();
  if(!token){ msg.textContent='يرجى تسجيل الدخول أولاً'; return; }

  const fd = new FormData(articleForm);
  const payload = {
    title: fd.get('title'),
    category: fd.get('category'),
    image: fd.get('image') || null,
    summary: fd.get('summary') || null,
    content: fd.get('content'),
    breaking: !!fd.get('breaking')
  };

  msg.textContent = 'جاري النشر...';
  try{
    const created = await api.createNews(payload, token);
    msg.textContent = 'نشر بنجاح! (ID: ' + created.id + ') - يمكنك الآن مشاهدة الخبر في الصفحة الرئيسية';
    articleForm.reset();
  }catch(err){
    msg.textContent = 'فشل النشر: ' + (err.message || 'خطأ غير معروف');
  }
});

// Auto-login if token exists
(async ()=>{
  const tok = getToken();
  if(tok){
    try{
      // Validate token by fetching news
      await api.getNews();
      showLoggedIn();
    }catch(e){
      // Token invalid, clear it
      showLoggedOut();
    }
  }
})();
</script>
</body>
</html>